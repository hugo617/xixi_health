<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç†æ§åˆ¶å° - MyShell Pro Style</title>
    <style>
        :root {
            /* æ ¸å¿ƒé…è‰²ï¼šMyShell é£æ ¼çš„è–„è·ç»¿ä¸æ·±æ—ç»¿ */
            --primary: #10b981;
            --primary-hover: #059669;
            --bg-color: #f0fdf4;
            --text-main: #111827;
            --text-sub: #6b7280;
            
            /* ç»ç’ƒæ‹Ÿæ€å‚æ•° */
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-blur: 24px;
            
            /* é˜´å½± */
            --card-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.15);
            --radius: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
            padding-bottom: 50px;
            margin: 0;
            
            /* MyShell æ ‡å¿—æ€§çš„ç‚¹é˜µèƒŒæ™¯çº¹ç† */
            background-image: 
                radial-gradient(var(--primary) 1.5px, transparent 1.5px),
                radial-gradient(rgba(16, 185, 129, 0.4) 1px, transparent 1px);
            background-size: 30px 30px, 10px 10px; /* åŒå±‚ç‚¹é˜µåˆ›é€ æ™¯æ·± */
            background-position: 0 0, 15px 15px;
        }

        /* ä¸»å®¹å™¨ï¼šå¼ºåŒ–çš„ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .container {
            width: 92%;
            max-width: 1100px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow), inset 0 0 0 1px rgba(255,255,255,0.5);
            padding: 40px;
            position: relative;
        }

        /* ---------------- å‰ç¥¥ç‰© (ç†ŠçŒ«) ---------------- */
        .mascot-container {
            position: absolute;
            top: -85px; /* è¶´åœ¨å¡ç‰‡é¡¶ç«¯ */
            right: 50px;
            width: 120px;
            height: 100px;
            z-index: 10;
            animation: float 5s ease-in-out infinite;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        /* ---------------- Header åŒºåŸŸ ---------------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .title-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #34d399, #059669);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.3);
        }

        .title-text h1 {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(to right, #065f46, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .title-text p {
            color: var(--text-sub);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        /* æ–°å¢ç”¨æˆ·æŒ‰é’® */
        .btn-add {
            background: var(--text-main);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-add:hover {
            background: #000;
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        /* ---------------- åŠŸèƒ½æ  (æœç´¢) ---------------- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 25px;
        }

        .search-box {
            position: relative;
            width: 100%;
            max-width: 350px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            border-radius: 14px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.6);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .search-box input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.08);
            background: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            color: var(--text-main);
            min-width: 150px;
            transition: border-color 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .btn-refresh {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(16,185,129,0.2);
            background: white;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-refresh:hover {
            background: rgba(16,185,129,0.08);
            border-color: var(--primary);
        }

        .btn-refresh.subtle {
            border-color: rgba(0,0,0,0.05);
            color: var(--text-main);
        }

        .btn-refresh.subtle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ---------------- è¡¨æ ¼åŒºåŸŸ ---------------- */
        .table-wrapper {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: auto; /* å¯ç”¨æ»šåŠ¨ */
            max-height: 70vh; /* æœ€å¤§é«˜åº¦70%è§†å£é«˜åº¦ */
            min-height: 400px; /* æœ€å°é«˜åº¦ */
        }

        /* è¡¨æ ¼æ»šåŠ¨å®¹å™¨ */
        .table-scroll-container {
            overflow: auto;
            position: relative;
            max-height: inherit;
        }

        /* å›ºå®šè¡¨å¤´æ ·å¼ */
        .table-wrapper thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(16, 185, 129, 0.2);
        }

        /* ä¼˜åŒ–è¡¨æ ¼å¸ƒå±€ */
        .data-table {
            width: auto;
            min-width: 100%; /* ä¿è¯è¡¨æ ¼å¯ä»¥æ¨ªå‘æ‰©å±• */
            border-collapse: separate;
            border-spacing: 0;
        }

        /* >>>>> ä¿®å¤æ ¸å¿ƒå¼€å§‹ï¼šåˆ—å®½ä¸æº¢å‡ºå¤„ç† <<<<< */
        .data-table th,
        .data-table td {
            white-space: nowrap; /* é˜²æ­¢æ–‡æœ¬æ¢è¡Œ */
            max-width: 300px; /* æœ€å¤§åˆ—å®½ */
            min-width: 80px; /* æœ€å°åˆ—å®½ */
        }

        /* å•ç‹¬å¤„ç† tdï¼šå†…å®¹è¿‡é•¿æ˜¾ç¤ºçœç•¥å· */
        .data-table td {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å•ç‹¬å¤„ç† thï¼šä¸å…è®¸çœç•¥å·ï¼Œç¡®ä¿å›¾æ ‡æ˜¾ç¤º */
        .data-table th {
            overflow: visible;
            text-overflow: clip;
        }

        /* ç‰¹å®šåˆ—å®½è®¾ç½®ï¼ˆè°ƒæ•´äº†éƒ¨åˆ†å®½åº¦ä»¥é€‚åº”å±…ä¸­å’Œå›¾æ ‡ï¼‰ */
        .data-table th:nth-child(1), /* ç”¨æˆ·å */
        .data-table td:nth-child(1) {
            min-width: 150px;
            max-width: 200px;
        }

        .data-table th:nth-child(2), /* é‚®ç®± */
        .data-table td:nth-child(2) {
            min-width: 200px;
            max-width: 250px;
        }

        .data-table th:nth-child(3), /* æ‰‹æœºå· */
        .data-table td:nth-child(3) {
            min-width: 120px;
            max-width: 150px;
        }

        /* ä¿®å¤ï¼šå¢åŠ å®½åº¦ä»¥å®¹çº³æ–‡å­—å’Œæ’åºå›¾æ ‡ */
        .data-table th:nth-child(4), /* è§’è‰² */
        .data-table td:nth-child(4) {
            min-width: 110px; /* ä»100pxè°ƒæ•´åˆ°110px */
            max-width: 130px;
        }

        /* ä¿®å¤ï¼šå¢åŠ å®½åº¦ä»¥å®¹çº³æ–‡å­—å’Œæ’åºå›¾æ ‡ */
        .data-table th:nth-child(5), /* ä¼šå‘˜ç±»å‹ */
        .data-table td:nth-child(5) {
            min-width: 110px; /* ä»100pxè°ƒæ•´åˆ°110px */
            max-width: 130px;
        }

        .data-table th:nth-child(6), /* æ³¨å†Œæ—¶é—´ */
        .data-table td:nth-child(6) {
            min-width: 120px;
            max-width: 150px;
        }

        .data-table th:nth-child(7), /* æœ€è¿‘æ›´æ–° */
        .data-table td:nth-child(7) {
            min-width: 120px;
            max-width: 160px;
        }

        .data-table th:nth-child(8), /* çŠ¶æ€ */
        .data-table td:nth-child(8) {
            min-width: 90px;
            max-width: 110px;
        }

        .data-table th:nth-child(9), /* æ“ä½œ */
        .data-table td:nth-child(9) {
            min-width: 150px;
            max-width: 190px;
        }
        /* >>>>> ä¿®å¤æ ¸å¿ƒç»“æŸ <<<<< */

        /* è¡Œé«˜ä¼˜åŒ– */
        .data-table th {
            height: 50px; /* å›ºå®šè¡¨å¤´é«˜åº¦ */
            line-height: 1.2;
        }

        .data-table td {
            height: 60px; /* å›ºå®šè¡Œé«˜ */
            line-height: 1.4;
            vertical-align: middle;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.5);
        }

        /* æ¨ªå‘æ»šåŠ¨æŒ‡ç¤ºå™¨ */
        .table-scroll-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(16, 185, 129, 0.2);
            color: #047857;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table-scroll-indicator.show {
            opacity: 1;
        }

        /* å“åº”å¼è¡¨æ ¼é«˜åº¦ */
        @media (max-height: 800px) {
            .table-wrapper {
                max-height: 60vh;
            }
        }

        @media (max-height: 600px) {
            .table-wrapper {
                max-height: 50vh;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }

            .filter-select {
                flex: 1;
                min-width: calc(33% - 8px);
            }

            .table-wrapper {
                max-height: 50vh;
                margin: 0 -10px; /* ç§»åŠ¨ç«¯è¾¹ç¼˜æ‰©å±• */
                border-radius: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 16px; /* å‡å°ç§»åŠ¨ç«¯å†…è¾¹è· */
                font-size: 0.85rem;
                min-width: 70px; /* ç§»åŠ¨ç«¯å‡å°æœ€å°å®½åº¦ */
                max-width: 200px; /* ç§»åŠ¨ç«¯å‡å°æœ€å¤§å®½åº¦ */
            }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ–åˆ—å®½ */
            .data-table th:nth-child(1), /* ç”¨æˆ·å */
            .data-table td:nth-child(1) {
                min-width: 120px;
                max-width: 150px;
            }
            
            .data-table th:nth-child(2), /* é‚®ç®± */
            .data-table td:nth-child(2) {
                min-width: 150px;
                max-width: 180px;
            }
            
            .data-table th:nth-child(3), /* æ‰‹æœºå· */
            .data-table td:nth-child(3) {
                min-width: 100px;
                max-width: 120px;
            }
            
            .data-table th:nth-child(4), /* è§’è‰² */
            .data-table td:nth-child(4) {
                min-width: 80px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(5), /* ä¼šå‘˜ç±»å‹ */
            .data-table td:nth-child(5) {
                min-width: 80px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(6), /* æ³¨å†Œæ—¶é—´ */
            .data-table td:nth-child(6) {
                min-width: 100px;
                max-width: 120px;
            }
            
            .data-table th:nth-child(7), /* æœ€è¿‘æ›´æ–° */
            .data-table td:nth-child(7) {
                min-width: 110px;
                max-width: 130px;
            }
            
            .data-table th:nth-child(8), /* çŠ¶æ€ */
            .data-table td:nth-child(8) {
                min-width: 70px;
                max-width: 90px;
            }
            
            .data-table th:nth-child(9), /* æ“ä½œ */
            .data-table td:nth-child(9) {
                min-width: 120px;
                max-width: 150px;
            }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ–æŒ‰é’®å¤§å° */
            .btn-action {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin-right: 4px;
            }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ–ç”¨æˆ·å•å…ƒæ ¼ */
            .user-cell {
                gap: 8px;
            }
            
            .user-cell .avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            
            /* ç§»åŠ¨ç«¯æ»šåŠ¨æŒ‡ç¤ºå™¨ä¼˜åŒ– */
            .table-scroll-indicator {
                font-size: 0.7rem;
                padding: 3px 6px;
                bottom: 5px;
                right: 5px;
            }
        }

        @media (max-width: 480px) {
            .table-wrapper {
                max-height: 45vh;
                margin: 0 -15px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            /* è¶…å°å±å¹•æ—¶éšè—æŸäº›åˆ—çš„æ’åºå›¾æ ‡ */
            .sort-icon {
                font-size: 10px;
                margin-left: 2px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .table-wrapper::-webkit-scrollbar {
                width: 12px;
                height: 12px;
            }
            
            .table-wrapper::-webkit-scrollbar-thumb {
                background: rgba(16, 185, 129, 0.6);
                min-height: 20px;
                min-width: 20px;
            }
            
            .table-wrapper {
                -webkit-overflow-scrolling: touch; /* iOSæƒ¯æ€§æ»šåŠ¨ */
            }
        }

        /* æ‰“å°æ ·å¼ä¼˜åŒ– */
        @media print {
            .table-wrapper {
                max-height: none !important;
                overflow: visible !important;
                border: 1px solid #ddd;
            }
            
            .table-scroll-indicator {
                display: none !important;
            }
            
            .data-table th,
            .data-table td {
                white-space: normal !important;
                max-width: none !important;
                min-width: auto !important;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* >>>>> ä¿®å¤æ ¸å¿ƒï¼šè¡¨å¤´å±…ä¸­ <<<<< */
        th {
            text-align: center; /* æ”¹ä¸ºå±…ä¸­ */
            padding: 18px 24px;
            color: #047857;
            font-weight: 700;
            font-size: 0.9rem;
            background: rgba(16, 185, 129, 0.05);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            font-size: 0.95rem;
            vertical-align: middle;
            text-align: left; /* ä¿æŒæ•°æ®å·¦å¯¹é½ï¼Œå¦‚æœéœ€è¦ä¹Ÿå¯ä»¥æ”¹ä¸ºcenter */
        }

        tr:last-child td { border-bottom: none; }
        
        /* è¡¨æ ¼è¡Œæ‚¬åœæ•ˆæœ */
        tr:hover {
            background-color: rgba(255,255,255,0.8);
        }

        /* ç”¨æˆ·åå•å…ƒæ ¼æ ·å¼ */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #a7f3d0, #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #064e3b;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-active { background: #dcfce7; color: #15803d; }
        .status-inactive { background: #f3f4f6; color: #4b5563; }
        .status-banned { background: #fee2e2; color: #b91c1c; }
        
        /* è§’è‰²æ ‡ç­¾ */
        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-user { background: #f0f9ff; color: #0369a1; }
        
        /* ä¼šå‘˜ç±»å‹æ ‡ç­¾ */
        .membership-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .membership-session_card { background: #fef3c7; color: #92400e; }
        .membership-monthly_card { background: #ddd6fe; color: #7c3aed; }
        .membership-annual_card { background: #a7f3d0; color: #047857; }
        .membership-no_membership { background: #f3f4f6; color: #6b7280; }
        
        /* çŠ¶æ€åœ†ç‚¹ */
        .dot {
            width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background: currentColor;
        }

        /* æ“ä½œæŒ‰é’® */
        .btn-action {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            margin-right: 6px;
            transition: 0.2s;
        }
        .btn-edit { background: white; border-color: #e5e7eb; color: var(--text-main); }
        .btn-edit:hover { border-color: var(--primary); color: var(--primary); }
        .btn-del { background: white; border-color: #fca5a5; color: #ef4444; }
        .btn-del:hover { background: #fef2f2; border-color: #ef4444; }

        /* æ’åºå›¾æ ‡ */
        .sort-icon {
            display: inline-block;
            width: 15px;
            margin-left: 5px;
            text-align: center;
            color: var(--primary);
            opacity: 0.7;
        }

        .sort-icon.active {
            opacity: 1;
            font-weight: 700;
        }

        /* åˆ†é¡µç»„ä»¶ */
        .pagination-wrapper {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .pagination-info {
            color: var(--text-sub);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
        }

        .pagination-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn:disabled:hover {
            border-color: #e5e7eb;
            color: inherit;
        }

        .page-size-selector {
            margin-left: 15px;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .page-size-selector:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ---------------- æ¨¡æ€æ¡† (æ–°å¢/ç¼–è¾‘) ---------------- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px); /* æ¨¡ç³ŠèƒŒæ™¯ */
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }

        .modal-card {
            background: white;
            width: 100%;
            max-width: 420px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.show .modal-card { transform: scale(1); }

        .modal-header h2 { margin-bottom: 20px; font-size: 1.5rem; color: #111827; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; color: var(--text-sub); }
        .form-input {
            width: 100%; padding: 12px;
            border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 1rem; outline: none; transition: 0.2s;
        }
        .form-input:focus { border-color: var(--primary); }

        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 500; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .btn-submit:hover { background: var(--primary-hover); }

    </style>
</head>
<body>

    <div class="container">
        <!-- å‰ç¥¥ç‰©ï¼šè¶´åœ¨å¡ç‰‡ä¸Šçš„ç†ŠçŒ« -->
        <div class="mascot-container">
            <svg viewBox="0 0 200 160" xmlns="http://www.w3.org/2000/svg">
                <!-- èº«ä½“é˜´å½± -->
                <path d="M40 160 Q100 150 160 160" fill="none" stroke="rgba(0,0,0,0.1)" stroke-width="4"/>
                <!-- è€³æœµ -->
                <circle cx="50" cy="50" r="22" fill="#1f2937"/>
                <circle cx="150" cy="50" r="22" fill="#1f2937"/>
                <!-- è„¸ -->
                <ellipse cx="100" cy="90" rx="70" ry="60" fill="#fff"/>
                <!-- çœ¼ç› -->
                <ellipse cx="70" cy="85" rx="18" ry="22" fill="#1f2937" transform="rotate(-20 70 85)"/>
                <ellipse cx="130" cy="85" rx="18" ry="22" fill="#1f2937" transform="rotate(20 130 85)"/>
                <circle cx="72" cy="82" r="5" fill="#fff"/>
                <circle cx="128" cy="82" r="5" fill="#fff"/>
                <!-- é¼»å­ -->
                <ellipse cx="100" cy="115" rx="10" ry="7" fill="#1f2937"/>
                <!-- è£…é¥°ï¼šå°ç«¹å¶ -->
                <path d="M140 120 Q160 100 180 110 Q160 120 140 120" fill="#10b981"/>
            </svg>
        </div>

        <div class="header">
            <div class="title-group">
                <!-- MyShell é£æ ¼ Logo -->
                <div class="logo-box">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </div>
                <div class="title-text">
                    <h1>User Management</h1>
                    <p>ç®¡ç†ç³»ç»Ÿæ ¸å¿ƒç”¨æˆ·æ•°æ®</p>
                </div>
            </div>
            
            <!-- æ–°å¢åŠŸèƒ½ï¼šæ·»åŠ ç”¨æˆ·æŒ‰é’® -->
            <button class="btn-add" onclick="openAddModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                </svg>
                æ–°å¢ç”¨æˆ·
            </button>
        </div>

        <div class="controls">
            <div class="search-box">
                <span class="search-icon">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </span>
                <input type="text" id="searchInput" placeholder="æœç´¢å§“å / é‚®ç®± / æ‰‹æœºå·">
            </div>
            <div class="filter-group">
                <select id="filterStatus" class="filter-select" aria-label="ç­›é€‰ç”¨æˆ·çŠ¶æ€">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active">æ­£å¸¸ç”¨æˆ·</option>
                    <option value="inactive">å·²åœç”¨</option>
                </select>
                <select id="filterRole" class="filter-select" aria-label="ç­›é€‰ç”¨æˆ·è§’è‰²">
                    <option value="">å…¨éƒ¨è§’è‰²</option>
                    <option value="admin">ç®¡ç†å‘˜</option>
                    <option value="user">æ™®é€šç”¨æˆ·</option>
                </select>
                <select id="filterMembership" class="filter-select" aria-label="ç­›é€‰ä¼šå‘˜ç±»å‹">
                    <option value="">å…¨éƒ¨ä¼šå‘˜</option>
                    <option value="annual_card">å¹´å¡</option>
                    <option value="monthly_card">æœˆå¡</option>
                    <option value="session_card">æ¬¡å¡</option>
                    <option value="no_membership">æ— ä¼šå‘˜</option>
                </select>
                <button type="button" class="btn-refresh" id="btnResetFilters">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 1 0 6 4.33"/></svg>
                    æ¸…é™¤ç­›é€‰
                </button>
                <button type="button" class="btn-refresh subtle" id="btnRefresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 15A9 9 0 1 0 18 19.67"/></svg>
                    åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll-container" id="tableScrollContainer">
                <table id="userTable" class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('username')">
                                ç”¨æˆ·å <span id="icon-username" class="sort-icon">â‡…</span>
                            </th>
                            <th>é‚®ç®±åœ°å€</th>
                            <th onclick="sortTable('phone')">
                                æ‰‹æœºå· <span id="icon-phone" class="sort-icon">â‡…</span>
                            </th>
                            <th onclick="sortTable('role')">
                                ç”¨æˆ·è§’è‰² <span id="icon-role" class="sort-icon">â‡…</span>
                            </th>
                            <th onclick="sortTable('membership_type')">
                                ä¼šå‘˜ç±»å‹ <span id="icon-membership_type" class="sort-icon">â‡…</span>
                            </th>
                            <th onclick="sortTable('regTime')">
                                æ³¨å†Œæ—¶é—´ <span id="icon-regTime" class="sort-icon">â‡…</span>
                            </th>
                            <th onclick="sortTable('updatedAt')">
                                æœ€è¿‘æ›´æ–° <span id="icon-updatedAt" class="sort-icon">â‡…</span>
                            </th>
                            <th>ç”¨æˆ·çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- æ•°æ®å°†ç”± JS æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>
            <div class="table-scroll-indicator" id="scrollIndicator">
                â† æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹æ›´å¤š â†’
            </div>
        </div>

        <!-- åˆ†é¡µç»„ä»¶ -->
        <div class="pagination-wrapper" id="paginationWrapper">
            <!-- åˆ†é¡µæ§ä»¶å°†ç”± JS æ¸²æŸ“ -->
        </div>
    </div>

    <!-- 1. æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2>ğŸ‘¤ æ·»åŠ æ–°ç”¨æˆ·</h2>
            </div>
            <form id="addForm">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="addUsername" class="form-input" placeholder="ä¾‹å¦‚: PandaUser" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" id="addEmail" class="form-input" placeholder="user@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">åˆå§‹çŠ¶æ€</label>
                    <select id="addStatus" class="form-input">
                        <option value="Active">æ­£å¸¸ (Active)</option>
                        <option value="Inactive">åœç”¨ (Inactive)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('addModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ç¡®è®¤æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2>âœï¸ ç¼–è¾‘ç”¨æˆ·</h2>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="editUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" id="editEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="tel" id="editPhone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·è§’è‰²</label>
                    <select id="editRole" class="form-input">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼šå‘˜ç±»å‹</label>
                    <select id="editMembership" class="form-input">
                        <option value="no_membership">æ— ä¼šå‘˜</option>
                        <option value="session_card">æ¬¡å¡</option>
                        <option value="monthly_card">æœˆå¡</option>
                        <option value="annual_card">å¹´å¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·çŠ¶æ€</label>
                    <select id="editStatus" class="form-input">
                        <option value="Active">æ­£å¸¸ (Active)</option>
                        <option value="Inactive">åœç”¨ (Inactive)</option>
                        <option value="Banned">å°ç¦ (Banned)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/v1/users/search';
        const MEMBERSHIP_TEXT = {
            session_card: 'æ¬¡å¡',
            monthly_card: 'æœˆå¡',
            annual_card: 'å¹´å¡',
            no_membership: 'æ— ä¼šå‘˜'
        };

        const state = {
            users: [],
            currentData: [],
            isLoading: false,
            currentPage: 1,
            perPage: 20,
            totalPages: 1,
            totalCount: 0,
            keyword: '',
            filters: {
                status: '',
                role: '',
                membership_type: ''
            },
            sortStates: {
                username: 'none',
                regTime: 'none',
                updatedAt: 'none',
                phone: 'none',
                role: 'none',
                membership_type: 'none'
            },
            scrollInitialized: false
        };

        const SORT_ICONS = { asc: 'â†‘', desc: 'â†“', none: 'â‡…' };

        function debounce(fn, delay = 300) {
            let timerId;
            return (...args) => {
                if (timerId) {
                    clearTimeout(timerId);
                }
                timerId = setTimeout(() => fn(...args), delay);
            };
        }

        const debouncedSearch = debounce((keyword) => {
            loadUsersData({ keyword, page: 1 });
        }, 350);

        document.addEventListener('DOMContentLoaded', () => {
            bindInteractions();
            bindFormHandlers();
            loadUsersData();
            initializeTableScroll();

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    loadUsersData({ page: state.currentPage });
                }
            });

            window.addEventListener('focus', () => {
                loadUsersData({ page: state.currentPage });
            });

            window.addEventListener('resize', () => {
                setTimeout(checkTableOverflow, 120);
            });
        });

        function bindInteractions() {
            const searchInput = document.getElementById('searchInput');
            const filterStatus = document.getElementById('filterStatus');
            const filterRole = document.getElementById('filterRole');
            const filterMembership = document.getElementById('filterMembership');
            const resetBtn = document.getElementById('btnResetFilters');
            const refreshBtn = document.getElementById('btnRefresh');

            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }

            if (filterStatus) {
                filterStatus.addEventListener('change', (event) => handleFilterChange('status', event.target.value));
            }

            if (filterRole) {
                filterRole.addEventListener('change', (event) => handleFilterChange('role', event.target.value));
            }

            if (filterMembership) {
                filterMembership.addEventListener('change', (event) => handleFilterChange('membership_type', event.target.value));
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', resetFilters);
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => loadUsersData({ page: state.currentPage }));
            }
        }

        function bindFormHandlers() {
            const addForm = document.getElementById('addForm');
            const editForm = document.getElementById('editForm');

            if (addForm) {
                addForm.addEventListener('submit', handleAddSubmit);
            }

            if (editForm) {
                editForm.addEventListener('submit', handleEditSubmit);
            }
        }

        function handleSearch(event) {
            const keyword = event.target.value.trim();
            debouncedSearch(keyword);
        }

        function handleFilterChange(key, value) {
            state.filters[key] = value;
            loadUsersData({ page: 1 });
        }

        function resetFilters() {
            state.filters = { status: '', role: '', membership_type: '' };
            state.keyword = '';
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';

            const filterStatus = document.getElementById('filterStatus');
            const filterRole = document.getElementById('filterRole');
            const filterMembership = document.getElementById('filterMembership');
            if (filterStatus) filterStatus.value = '';
            if (filterRole) filterRole.value = '';
            if (filterMembership) filterMembership.value = '';

            loadUsersData({ page: 1 });
        }

        function buildFiltersPayload() {
            const payload = {};
            if (state.keyword) {
                payload.name = state.keyword;
            }
            Object.entries(state.filters).forEach(([key, value]) => {
                if (value) {
                    payload[key] = value;
                }
            });
            return payload;
        }

        function mapUserFromApi(user) {
            const createdAt = user.created_at || '';
            const updatedAt = user.updated_at || createdAt;
            return {
                id: user.id,
                username: user.nickname || 'æœªå‘½åç”¨æˆ·',
                email: user.email || '-',
                phone: user.phone || '',
                role: user.role || 'user',
                membership_type: user.membership_type || 'no_membership',
                status: (user.status || 'inactive').toLowerCase(),
                createdAtRaw: createdAt ? Date.parse(createdAt) : null,
                updatedAtRaw: updatedAt ? Date.parse(updatedAt) : null,
                createdAtDisplay: formatDateShort(createdAt),
                updatedAtDisplay: formatDateShort(updatedAt),
                createdAtFull: formatDateLong(createdAt),
                updatedAtFull: formatDateLong(updatedAt),
                createdAtSource: createdAt,
                updatedAtSource: updatedAt
            };
        }

        function formatDateShort(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatDateLong(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('zh-CN', { hour12: false });
        }

        async function loadUsersData(options = {}) {
            if (state.isLoading) return;

            const keyword = options.keyword !== undefined ? options.keyword : state.keyword;
            const page = options.page || 1;
            const pageSize = options.pageSize || state.perPage;

            state.isLoading = true;
            state.keyword = keyword;
            state.currentPage = page;
            state.perPage = pageSize;
            showLoadingState();

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        filters: buildFiltersPayload(),
                        pagination: {
                            page: state.currentPage,
                            per_page: state.perPage
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }

                const pagination = result.data.pagination || {};
                state.totalPages = Math.max(pagination.total_pages || 1, 1);
                state.totalCount = pagination.total_count || 0;

                if (state.totalCount > 0 && state.currentPage > state.totalPages) {
                    state.currentPage = state.totalPages;
                    state.isLoading = false;
                    return loadUsersData({ page: state.currentPage });
                }

                state.users = (result.data.users || []).map(mapUserFromApi);
                state.currentData = [...state.users];
                resetSortIcons();
                renderTable(state.currentData);
                renderPagination();

                setTimeout(() => {
                    adjustColumnWidths();
                    checkTableOverflow();
                }, 60);
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                showErrorState(error.message);
            } finally {
                state.isLoading = false;
            }
        }

        function showLoadingState() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #999; white-space: normal;">ğŸ”„ æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">è¯·ç¨å€™ï¼Œæ­£åœ¨ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®</small></td></tr>';
        }

        function showErrorState(errorMessage) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 40px; color: #e53e3e; white-space: normal;">âŒ åŠ è½½å¤±è´¥: ${errorMessage}<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</small><br><button onclick="loadUsersData()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">é‡æ–°åŠ è½½</button></td></tr>`;
        }

        function renderPagination() {
            const wrapper = document.getElementById('paginationWrapper');
            if (!wrapper) return;

            const hasData = state.totalCount > 0;
            const startItem = hasData ? (state.currentPage - 1) * state.perPage + 1 : 0;
            const endItem = hasData ? Math.min(state.currentPage * state.perPage, state.totalCount) : 0;

            let html = `
                <div class="pagination-info">
                    <span>æ˜¾ç¤º ${hasData ? startItem : 0}-${hasData ? endItem : 0} æ¡ï¼Œå…± ${state.totalCount} æ¡è®°å½•</span>
                    <span>ç¬¬ ${state.currentPage} / ${state.totalPages} é¡µ</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
            `;

            const maxVisiblePages = 5;
            let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(state.totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                html += `<button class="pagination-btn ${state.currentPage === 1 ? 'active' : ''}" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis" style="padding: 0 4px;">...</span>`;
                }
            }

            for (let page = startPage; page <= endPage; page++) {
                html += `<button class="pagination-btn ${page === state.currentPage ? 'active' : ''}" onclick="changePage(${page})">${page}</button>`;
            }

            if (endPage < state.totalPages) {
                if (endPage < state.totalPages - 1) {
                    html += `<span class="pagination-ellipsis" style="padding: 0 4px;">...</span>`;
                }
                html += `<button class="pagination-btn ${state.currentPage === state.totalPages ? 'active' : ''}" onclick="changePage(${state.totalPages})">${state.totalPages}</button>`;
            }

            html += `
                    <button class="pagination-btn" onclick="changePage(${state.currentPage + 1})" ${state.currentPage === state.totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                    <select class="page-size-selector" onchange="changePageSize(this.value)">
                        <option value="10" ${state.perPage === 10 ? 'selected' : ''}>10æ¡/é¡µ</option>
                        <option value="20" ${state.perPage === 20 ? 'selected' : ''}>20æ¡/é¡µ</option>
                        <option value="50" ${state.perPage === 50 ? 'selected' : ''}>50æ¡/é¡µ</option>
                        <option value="100" ${state.perPage === 100 ? 'selected' : ''}>100æ¡/é¡µ</option>
                    </select>
                </div>
            `;

            wrapper.innerHTML = html;
        }

        function changePage(page) {
            if (page < 1 || page > state.totalPages || page === state.currentPage) return;
            loadUsersData({ page });
        }

        function changePageSize(value) {
            const size = Math.min(Math.max(parseInt(value, 10) || 20, 1), 100);
            loadUsersData({ page: 1, pageSize: size });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #999; white-space: normal;">ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æ¸…é™¤æœç´¢å…³é”®è¯</small></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach((user) => {
                const safeName = user.username || 'æœªå‘½åç”¨æˆ·';
                const avatarText = safeName.trim().charAt(0).toUpperCase() || 'U';
                const statusMeta = getStatusMeta(user.status);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-cell">
                            <div class="avatar">${avatarText}</div>
                            <span style="font-weight:600;" title="${safeName}">${optimizeTextDisplay(safeName, 15)}</span>
                        </div>
                    </td>
                    <td style="color:var(--text-sub);" title="${user.email}">${optimizeTextDisplay(user.email, 25)}</td>
                    <td style="color:var(--text-sub);" title="${user.phone}">${user.phone ? optimizeTextDisplay(user.phone, 15) : '-'}</td>
                    <td>
                        <span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}" title="${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}">
                            ${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                        </span>
                    </td>
                    <td>
                        <span class="membership-badge membership-${user.membership_type}" title="${getMembershipText(user.membership_type)}">
                            ${getMembershipText(user.membership_type)}
                        </span>
                    </td>
                    <td style="font-family:monospace; color:var(--text-sub);" title="${user.createdAtFull}">${user.createdAtDisplay}</td>
                    <td style="font-family:monospace; color:var(--text-sub);" title="${user.updatedAtFull}">${user.updatedAtDisplay}</td>
                    <td>
                        <span class="badge ${statusMeta.cssClass}" title="${statusMeta.text}">
                            <span class="dot"></span>${statusMeta.text}
                        </span>
                    </td>
                    <td>
                        <button class="btn-action btn-edit" onclick="openEdit(${user.id})" title="ç¼–è¾‘ç”¨æˆ·">ç¼–è¾‘</button>
                        <button class="btn-action btn-del" onclick="deleteUser(${user.id})" title="åˆ é™¤ç”¨æˆ·">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function optimizeTextDisplay(text, maxLength = 50) {
            if (!text) return '-';
            return text.length <= maxLength ? text : `${text.substring(0, maxLength)}...`;
        }

        function getStatusMeta(status) {
            const normalized = (status || 'inactive').toLowerCase();
            if (normalized === 'active') return { cssClass: 'status-active', text: 'æ­£å¸¸' };
            if (normalized === 'inactive') return { cssClass: 'status-inactive', text: 'åœç”¨' };
            return { cssClass: 'status-banned', text: 'å°ç¦' };
        }

        function getMembershipText(value) {
            return MEMBERSHIP_TEXT[value] || 'æœªçŸ¥';
        }

        function sortTable(key) {
            const currentState = state.sortStates[key] || 'none';
            const nextState = currentState === 'asc' ? 'desc' : 'asc';
            state.sortStates[key] = nextState;
            updateSortIcons(key);

            state.currentData.sort((a, b) => {
                let aValue;
                let bValue;

                switch (key) {
                    case 'username':
                        aValue = (a.username || '').toLowerCase();
                        bValue = (b.username || '').toLowerCase();
                        break;
                    case 'phone':
                        aValue = a.phone || '';
                        bValue = b.phone || '';
                        break;
                    case 'role':
                        const roleOrder = { admin: 0, user: 1 };
                        aValue = roleOrder[a.role] ?? 2;
                        bValue = roleOrder[b.role] ?? 2;
                        break;
                    case 'membership_type':
                        const membershipOrder = { annual_card: 0, monthly_card: 1, session_card: 2, no_membership: 3 };
                        aValue = membershipOrder[a.membership_type] ?? 4;
                        bValue = membershipOrder[b.membership_type] ?? 4;
                        break;
                    case 'regTime':
                        aValue = a.createdAtRaw || 0;
                        bValue = b.createdAtRaw || 0;
                        break;
                    case 'updatedAt':
                        aValue = a.updatedAtRaw || 0;
                        bValue = b.updatedAtRaw || 0;
                        break;
                    default:
                        aValue = a[key];
                        bValue = b[key];
                }

                if (aValue < bValue) return nextState === 'asc' ? -1 : 1;
                if (aValue > bValue) return nextState === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(state.currentData);
        }

        function updateSortIcons(activeKey) {
            Object.keys(state.sortStates).forEach((key) => {
                const icon = document.getElementById(`icon-${key}`);
                if (!icon) return;

                if (key === activeKey) {
                    icon.textContent = SORT_ICONS[state.sortStates[key]];
                    icon.classList.toggle('active', state.sortStates[key] !== 'none');
                } else {
                    state.sortStates[key] = 'none';
                    icon.textContent = SORT_ICONS.none;
                    icon.classList.remove('active');
                }
            });
        }

        function resetSortIcons() {
            Object.keys(state.sortStates).forEach((key) => {
                state.sortStates[key] = 'none';
                const icon = document.getElementById(`icon-${key}`);
                if (icon) {
                    icon.textContent = SORT_ICONS.none;
                    icon.classList.remove('active');
                }
            });
        }

        function initializeTableScroll() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            if (!scrollContainer) return;

            if (!state.scrollInitialized) {
                const scrollIndicator = document.getElementById('scrollIndicator');
                scrollContainer.addEventListener('scroll', () => {
                    if (!scrollIndicator) return;
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                    if (maxScroll <= 10) {
                        scrollIndicator.classList.remove('show');
                        return;
                    }

                    scrollIndicator.classList.add('show');
                    if (scrollContainer.scrollLeft < 50) {
                        scrollIndicator.textContent = 'â†’ æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹æ›´å¤š';
                    } else if (scrollContainer.scrollLeft > maxScroll - 50) {
                        scrollIndicator.textContent = 'â† å·²æ»šåŠ¨åˆ°æœ€å³ä¾§';
                    } else {
                        scrollIndicator.textContent = 'â† â†’ ç»§ç»­æ»šåŠ¨æŸ¥çœ‹æ›´å¤š';
                    }
                });
                state.scrollInitialized = true;
            }

            setTimeout(checkTableOverflow, 80);
        }

        function checkTableOverflow() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            const scrollIndicator = document.getElementById('scrollIndicator');
            if (!scrollContainer || !scrollIndicator) return;

            const hasOverflow = scrollContainer.scrollWidth > scrollContainer.clientWidth;
            scrollIndicator.classList.toggle('show', hasOverflow);
        }

        function adjustColumnWidths() {
            const table = document.getElementById('userTable');
            if (!table) return;

            const headerCells = Array.from(table.querySelectorAll('thead th'));
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (!rows.length) return;

            const maxWidths = new Array(headerCells.length).fill(0);
            headerCells.forEach((cell, index) => {
                maxWidths[index] = Math.max(maxWidths[index], cell.textContent.trim().length * 8 + 20);
            });

            rows.forEach((row) => {
                Array.from(row.children).forEach((cell, index) => {
                    const contentLength = cell.textContent.trim().length * 8 + 40;
                    maxWidths[index] = Math.max(maxWidths[index], contentLength);
                });
            });

            headerCells.forEach((cell, index) => {
                const style = getComputedStyle(cell);
                const minWidth = parseInt(style.minWidth, 10) || 80;
                const maxWidth = parseInt(style.maxWidth, 10) || 300;
                const optimal = Math.min(Math.max(maxWidths[index], minWidth), maxWidth);
                cell.style.width = `${optimal}px`;
                cell.style.minWidth = `${optimal}px`;
            });
        }

        function refreshLocalPagination() {
            state.totalCount = state.currentData.length;
            state.totalPages = Math.max(1, Math.ceil(state.totalCount / state.perPage));
            state.currentPage = Math.min(state.currentPage, state.totalPages);
        }

        async function deleteUser(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            state.users = state.users.filter((user) => user.id !== id);
            state.currentData = state.currentData.filter((user) => user.id !== id);
            refreshLocalPagination();
            renderTable(state.currentData);
            renderPagination();
            alert('ğŸ—‘ï¸ ç”¨æˆ·åˆ é™¤æˆåŠŸï¼ï¼ˆç¤ºä¾‹æ•°æ®æœªåŒæ­¥è‡³åç«¯ï¼‰');
        }

        function openAddModal() {
            const form = document.getElementById('addForm');
            if (form) form.reset();
            document.getElementById('addModal').classList.add('show');
        }

        function openEdit(id) {
            const user = state.users.find((item) => item.id === id);
            if (!user) return;

            document.getElementById('editId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editRole').value = user.role || 'user';
            document.getElementById('editMembership').value = user.membership_type || 'no_membership';
            const statusValue = user.status === 'active' ? 'Active' : user.status === 'inactive' ? 'Inactive' : 'Banned';
            document.getElementById('editStatus').value = statusValue;

            document.getElementById('editModal').classList.add('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        async function handleAddSubmit(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('.btn-submit');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'æ·»åŠ ä¸­...';
            submitButton.disabled = true;

            try {
                const now = new Date().toISOString();
                const newUser = mapUserFromApi({
                    id: Date.now(),
                    nickname: document.getElementById('addUsername').value,
                    email: document.getElementById('addEmail').value,
                    phone: '138' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0'),
                    role: 'user',
                    membership_type: 'no_membership',
                    status: document.getElementById('addStatus').value.toLowerCase(),
                    created_at: now,
                    updated_at: now
                });

                state.currentPage = 1;
                state.users.unshift(newUser);
                state.currentData.unshift(newUser);
                refreshLocalPagination();
                renderTable(state.currentData);
                renderPagination();

                closeModal('addModal');
                alert('ğŸ‰ æ–°ç”¨æˆ·æ·»åŠ æˆåŠŸï¼ï¼ˆç¤ºä¾‹æ•°æ®æœªåŒæ­¥è‡³åç«¯ï¼‰');
            } catch (error) {
                console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                alert('âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('.btn-submit');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'ä¿å­˜ä¸­...';
            submitButton.disabled = true;

            try {
                const id = parseInt(document.getElementById('editId').value, 10);
                const index = state.users.findIndex((user) => user.id === id);
                if (index === -1) {
                    throw new Error('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·');
                }

                const existing = state.users[index];
                const now = new Date().toISOString();
                const updatedUser = mapUserFromApi({
                    id: existing.id,
                    nickname: document.getElementById('editUsername').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    membership_type: document.getElementById('editMembership').value,
                    status: document.getElementById('editStatus').value.toLowerCase(),
                    created_at: existing.createdAtSource,
                    updated_at: now
                });

                state.users[index] = updatedUser;
                state.currentData = state.currentData.map((user) => (user.id === id ? updatedUser : user));
                renderTable(state.currentData);

                closeModal('editModal');
                alert('âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼ï¼ˆç¤ºä¾‹æ•°æ®æœªåŒæ­¥è‡³åç«¯ï¼‰');
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error);
                alert('âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        window.addEventListener('click', (event) => {
            if (event.target.classList && event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>