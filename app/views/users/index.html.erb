<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理控制台 - MyShell Pro Style</title>
    <style>
        :root {
            /* 核心配色：MyShell 风格的薄荷绿与深林绿 */
            --primary: #10b981;
            --primary-hover: #059669;
            --bg-color: #f0fdf4;
            --text-main: #111827;
            --text-sub: #6b7280;
            
            /* 玻璃拟态参数 */
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-blur: 24px;
            
            /* 阴影 */
            --card-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.15);
            --radius: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
            padding-bottom: 50px;
            margin: 0;
            
            /* MyShell 标志性的点阵背景纹理 */
            background-image: 
                radial-gradient(var(--primary) 1.5px, transparent 1.5px),
                radial-gradient(rgba(16, 185, 129, 0.4) 1px, transparent 1px);
            background-size: 30px 30px, 10px 10px; /* 双层点阵创造景深 */
            background-position: 0 0, 15px 15px;
        }

        /* 主容器：强化的玻璃拟态效果 */
        .container {
            width: 92%;
            max-width: 1100px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow), inset 0 0 0 1px rgba(255,255,255,0.5);
            padding: 40px;
            position: relative;
        }

        /* ---------------- 吉祥物 (熊猫) ---------------- */
        .mascot-container {
            position: absolute;
            top: -85px; /* 趴在卡片顶端 */
            right: 50px;
            width: 120px;
            height: 100px;
            z-index: 10;
            animation: float 5s ease-in-out infinite;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        /* ---------------- Header 区域 ---------------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .title-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #34d399, #059669);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.3);
        }

        .title-text h1 {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(to right, #065f46, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .title-text p {
            color: var(--text-sub);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        /* 新增用户按钮 - 优化版 */
        .btn-add {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-add:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
        }
        .btn-add:active {
            transform: translateY(-1px) scale(0.98);
        }
        .btn-add::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        .btn-add:hover::before {
            left: 100%;
        }
        .btn-add svg {
            width: 22px;
            height: 22px;
            transition: transform 0.3s;
        }
        .btn-add:hover svg {
            transform: rotate(90deg) scale(1.1);
        }
        
        /* 新增用户按钮动画 */
        @keyframes pulse {
            0% { box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 8px 30px rgba(16, 185, 129, 0.5); }
            100% { box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
        }
        .btn-add {
            animation: pulse 2s infinite;
        }
        .btn-add:hover {
            animation: none;
        }

        /* ---------------- 功能栏 (搜索) ---------------- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 25px;
        }

        .search-box {
            position: relative;
            width: 100%;
            max-width: 350px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            border-radius: 14px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.6);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .search-box input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.08);
            background: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            color: var(--text-main);
            min-width: 150px;
            transition: border-color 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .btn-refresh {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(16,185,129,0.2);
            background: white;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-refresh:hover {
            background: rgba(16,185,129,0.08);
            border-color: var(--primary);
        }

        .btn-refresh.subtle {
            border-color: rgba(0,0,0,0.05);
            color: var(--text-main);
        }

        .btn-refresh.subtle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ---------------- 表格区域 ---------------- */
        .table-wrapper {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: auto; /* 启用滚动 */
            max-height: 70vh; /* 最大高度70%视口高度 */
            min-height: 400px; /* 最小高度 */
        }

        /* 表格滚动容器 */
        .table-scroll-container {
            overflow: auto;
            position: relative;
            max-height: inherit;
        }

        /* 固定表头样式 */
        .table-wrapper thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(16, 185, 129, 0.2);
        }

        /* 优化表格布局 */
        .data-table {
            width: auto;
            min-width: 100%; /* 保证表格可以横向扩展 */
            border-collapse: separate;
            border-spacing: 0;
        }

        /* >>>>> 修复核心开始：列宽与溢出处理 <<<<< */
        .data-table th,
        .data-table td {
            white-space: nowrap; /* 防止文本换行 */
            max-width: 300px; /* 最大列宽 */
            min-width: 80px; /* 最小列宽 */
        }

        /* 单独处理 td：内容过长显示省略号 */
        .data-table td {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 单独处理 th：不允许省略号，确保图标显示 */
        .data-table th {
            overflow: visible;
            text-overflow: clip;
        }

        /* 特定列宽设置（调整了部分宽度以适应居中和图标） */
        .data-table th:nth-child(1), /* 用户名 */
        .data-table td:nth-child(1) {
            min-width: 150px;
            max-width: 200px;
        }

        .data-table th:nth-child(2), /* 邮箱 */
        .data-table td:nth-child(2) {
            min-width: 200px;
            max-width: 250px;
        }

        .data-table th:nth-child(3), /* 手机号 */
        .data-table td:nth-child(3) {
            min-width: 120px;
            max-width: 150px;
        }

        /* 修复：增加宽度以容纳文字和排序图标 */
        .data-table th:nth-child(4), /* 角色 */
        .data-table td:nth-child(4) {
            min-width: 110px; /* 从100px调整到110px */
            max-width: 130px;
        }

        /* 修复：增加宽度以容纳文字和排序图标 */
        .data-table th:nth-child(5), /* 会员类型 */
        .data-table td:nth-child(5) {
            min-width: 110px; /* 从100px调整到110px */
            max-width: 130px;
        }

        .data-table th:nth-child(6), /* 注册时间 */
        .data-table td:nth-child(6) {
            min-width: 120px;
            max-width: 150px;
        }

        .data-table th:nth-child(7), /* 最近更新 */
        .data-table td:nth-child(7) {
            min-width: 120px;
            max-width: 160px;
        }

        .data-table th:nth-child(8), /* 状态 */
        .data-table td:nth-child(8) {
            min-width: 90px;
            max-width: 110px;
        }

        .data-table th:nth-child(9), /* 操作 */
        .data-table td:nth-child(9) {
            min-width: 150px;
            max-width: 190px;
        }
        /* >>>>> 修复核心结束 <<<<< */

        /* 行高优化 */
        .data-table th {
            height: 50px; /* 固定表头高度 */
            line-height: 1.2;
        }

        .data-table td {
            height: 60px; /* 固定行高 */
            line-height: 1.4;
            vertical-align: middle;
        }

        /* 滚动条美化 */
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.5);
        }

        /* 横向滚动指示器 */
        .table-scroll-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(16, 185, 129, 0.2);
            color: #047857;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table-scroll-indicator.show {
            opacity: 1;
        }

        /* 响应式表格高度 */
        @media (max-height: 800px) {
            .table-wrapper {
                max-height: 60vh;
            }
        }

        @media (max-height: 600px) {
            .table-wrapper {
                max-height: 50vh;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
                justify-content: space-between;
            }

            .filter-select {
                flex: 1;
                min-width: calc(33% - 8px);
            }

            .table-wrapper {
                max-height: 50vh;
                margin: 0 -10px; /* 移动端边缘扩展 */
                border-radius: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 16px; /* 减小移动端内边距 */
                font-size: 0.85rem;
                min-width: 70px; /* 移动端减小最小宽度 */
                max-width: 200px; /* 移动端减小最大宽度 */
            }
            
            /* 移动端优化列宽 */
            .data-table th:nth-child(1), /* 用户名 */
            .data-table td:nth-child(1) {
                min-width: 120px;
                max-width: 150px;
            }
            
            .data-table th:nth-child(2), /* 邮箱 */
            .data-table td:nth-child(2) {
                min-width: 150px;
                max-width: 180px;
            }
            
            .data-table th:nth-child(3), /* 手机号 */
            .data-table td:nth-child(3) {
                min-width: 100px;
                max-width: 120px;
            }
            
            .data-table th:nth-child(4), /* 角色 */
            .data-table td:nth-child(4) {
                min-width: 80px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(5), /* 会员类型 */
            .data-table td:nth-child(5) {
                min-width: 80px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(6), /* 注册时间 */
            .data-table td:nth-child(6) {
                min-width: 100px;
                max-width: 120px;
            }
            
            .data-table th:nth-child(7), /* 最近更新 */
            .data-table td:nth-child(7) {
                min-width: 110px;
                max-width: 130px;
            }
            
            .data-table th:nth-child(8), /* 状态 */
            .data-table td:nth-child(8) {
                min-width: 70px;
                max-width: 90px;
            }
            
            .data-table th:nth-child(9), /* 操作 */
            .data-table td:nth-child(9) {
                min-width: 120px;
                max-width: 150px;
            }
            
            /* 移动端优化按钮大小 */
            .btn-action {
                padding: 4px 8px;
                font-size: 0.75rem;
                margin-right: 4px;
            }
            
            /* 移动端优化用户单元格 */
            .user-cell {
                gap: 8px;
            }
            
            .user-cell .avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            
            /* 移动端滚动指示器优化 */
            .table-scroll-indicator {
                font-size: 0.7rem;
                padding: 3px 6px;
                bottom: 5px;
                right: 5px;
            }
        }

        @media (max-width: 480px) {
            .table-wrapper {
                max-height: 45vh;
                margin: 0 -15px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            /* 超小屏幕时隐藏某些列的排序图标 */
            .sort-icon {
                font-size: 10px;
                margin-left: 2px;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .table-wrapper::-webkit-scrollbar {
                width: 12px;
                height: 12px;
            }
            
            .table-wrapper::-webkit-scrollbar-thumb {
                background: rgba(16, 185, 129, 0.6);
                min-height: 20px;
                min-width: 20px;
            }
            
            .table-wrapper {
                -webkit-overflow-scrolling: touch; /* iOS惯性滚动 */
            }
        }

        /* 通知消息样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: rgba(220, 252, 231, 0.95);
            color: #15803d;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .notification.error {
            background: rgba(254, 226, 226, 0.95);
            color: #b91c1c;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .notification.info {
            background: rgba(224, 242, 254, 0.95);
            color: #1e40af;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* 打印样式优化 */
        @media print {
            .table-wrapper {
                max-height: none !important;
                overflow: visible !important;
                border: 1px solid #ddd;
            }
            
            .table-scroll-indicator {
                display: none !important;
            }
            
            .data-table th,
            .data-table td {
                white-space: normal !important;
                max-width: none !important;
                min-width: auto !important;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* >>>>> 修复核心：表头居中 <<<<< */
        th {
            text-align: center; /* 改为居中 */
            padding: 18px 24px;
            color: #047857;
            font-weight: 700;
            font-size: 0.9rem;
            background: rgba(16, 185, 129, 0.05);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            font-size: 0.95rem;
            vertical-align: middle;
            text-align: left; /* 保持数据左对齐，如果需要也可以改为center */
        }

        tr:last-child td { border-bottom: none; }
        
        /* 表格行悬停效果 */
        tr:hover {
            background-color: rgba(255,255,255,0.8);
        }

        /* 用户名单元格样式 */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #a7f3d0, #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #064e3b;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* 状态标签 */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-active { background: #dcfce7; color: #15803d; }
        .status-inactive { background: #f3f4f6; color: #4b5563; }
        .status-banned { background: #fee2e2; color: #b91c1c; }
        
        /* 角色标签 */
        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-user { background: #f0f9ff; color: #0369a1; }
        
        /* 会员类型标签 */
        .membership-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .membership-session_card { background: #fef3c7; color: #92400e; }
        .membership-monthly_card { background: #ddd6fe; color: #7c3aed; }
        .membership-annual_card { background: #a7f3d0; color: #047857; }
        .membership-no_membership { background: #f3f4f6; color: #6b7280; }
        
        /* 状态圆点 */
        .dot {
            width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background: currentColor;
        }

        /* 操作按钮 */
        .btn-action {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            margin-right: 6px;
            transition: 0.2s;
            position: relative;
        }
        .btn-edit { background: white; border-color: #e5e7eb; color: var(--text-main); }
        .btn-edit:hover { border-color: var(--primary); color: var(--primary); }
        .btn-del { background: white; border-color: #fca5a5; color: #ef4444; }
        .btn-del:hover { background: #fef2f2; border-color: #ef4444; }
        
        /* 按钮禁用状态 */
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* 操作按钮容器 */
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* 排序图标 */
        .sort-icon {
            display: inline-block;
            width: 15px;
            margin-left: 5px;
            text-align: center;
            color: var(--primary);
            opacity: 0.7;
        }

        .sort-icon.active {
            opacity: 1;
            font-weight: 700;
        }

        /* 分页组件 */
        .pagination-wrapper {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .pagination-info {
            color: var(--text-sub);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
        }

        .pagination-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn:disabled:hover {
            border-color: #e5e7eb;
            color: inherit;
        }

        .page-size-selector {
            margin-left: 15px;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .page-size-selector:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ---------------- 模态框 (新增/编辑) - 优化版 ---------------- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(12px); /* 增强模糊效果 */
            -webkit-backdrop-filter: blur(12px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.show { display: flex; opacity: 1; }

        .modal-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            width: 100%;
            max-width: 500px; /* 增加最大宽度 */
            max-height: 90vh; /* 限制最大高度 */
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.25), inset 0 0 0 1px rgba(255,255,255,0.6);
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden; /* 防止内容溢出 */
        }
        .modal-overlay.show .modal-card { 
            transform: scale(1) translateY(0); 
        }

        .modal-header {
            padding: 32px 32px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }
        .modal-header h2 { 
            font-size: 1.75rem; 
            color: #111827; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header h2::before {
            content: '👤';
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* 模态框内容区域 - 可滚动 */
        .modal-content {
            padding: 32px;
            max-height: calc(90vh - 200px); /* 动态计算最大高度 */
            overflow-y: auto; /* 启用垂直滚动 */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--primary) transparent; /* Firefox */
        }
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 3px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .form-group { 
            margin-bottom: 24px; 
            position: relative;
        }
        .form-label { 
            display: block; 
            margin-bottom: 10px; 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .form-input {
            width: 100%; 
            padding: 14px 16px;
            border: 2px solid #e5e7eb; 
            border-radius: 12px;
            font-size: 1rem; 
            outline: none; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .form-input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }
        .form-input:invalid { border-color: #ef4444; }
        .form-input:valid { border-color: #10b981; }

        .modal-footer { 
            padding: 24px 32px 32px;
            display: flex; 
            justify-content: flex-end; 
            gap: 16px; 
            background: rgba(255, 255, 255, 0.4);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .btn-cancel { 
            background: rgba(243, 244, 246, 0.8); 
            color: #4b5563; 
            border: 1px solid #e5e7eb; 
            padding: 12px 24px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .btn-cancel:hover { 
            background: rgba(229, 231, 235, 0.9); 
            border-color: #d1d5db;
            transform: translateY(-1px);
        }
        .btn-submit { 
            background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
            color: white; 
            border: none; 
            padding: 12px 28px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-submit:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-submit:active { 
            transform: translateY(0); 
        }
        
        /* 增强的表单验证样式 */
        .form-group .error-message {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 6px;
            display: none;
            font-weight: 500;
            padding-left: 4px;
        }
        .form-group.has-error .error-message {
            display: block;
        }
        .form-group.has-error .form-input {
            border-color: #ef4444;
            background: rgba(254, 226, 226, 0.3);
        }
        
        /* 必填字段指示器 */
        .required-indicator {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* 帮助文本样式 */
        .form-help {
            color: var(--text-sub);
            font-size: 0.8rem;
            margin-top: 6px;
            display: block;
            font-weight: 400;
        }
        
        /* 表单区域样式 */
        .form-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* 响应式表单布局 */
        @media (max-width: 640px) {
            .modal-card {
                max-width: 95vw;
                margin: 0 16px;
            }
            .modal-header,
            .modal-content,
            .modal-footer {
                padding: 24px;
            }
            .form-group {
                margin-bottom: 20px;
            }
        }
        
        /* 加载状态增强 */
        .btn-submit.loading {
            position: relative;
            color: transparent;
        }
        .btn-submit.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 成功状态样式 */
        .form-group.success .form-input {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        /* 表单输入增强 */
        .form-input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }
        
        /* 选择框增强 */
        .form-input:focus {
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* 按钮组增强 */
        .modal-footer {
            gap: 12px;
        }
        
        /* 确保按钮可点击且可见 */
        .btn-submit {
            cursor: pointer !important;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .btn-submit:hover {
            cursor: pointer;
        }
        
        .btn-submit:disabled {
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        /* 按钮点击反馈 */
        .btn-submit:active {
            transform: translateY(1px) !important;
        }
        
        @media (max-width: 480px) {
            .modal-footer {
                flex-direction: column;
            }
            .btn-cancel,
            .btn-submit {
                width: 100%;
            }
        }
        
        /* 密码强度指示器 */
        .password-strength {
            margin-top: 8px;
        }
        
        /* 表单输入增强动画 */
        .form-input {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* 成功状态动画 */
        .form-group.success .form-input {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
            animation: successPulse 0.5s ease;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* 错误状态动画 */
        .form-group.has-error .form-input {
            animation: errorShake 0.4s ease;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        
        /* 模态框标题动画 */
        .modal-header h2 {
            animation: slideInLeft 0.5s ease-out;
        }
        
        @keyframes slideInLeft {
            0% { 
                opacity: 0; 
                transform: translateX(-20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        /* 表单区域动画 */
        .form-section {
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .form-section:nth-child(1) { animation-delay: 0.1s; }
        .form-section:nth-child(2) { animation-delay: 0.2s; }
        .form-section:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes fadeInUp {
            0% { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- 吉祥物：趴在卡片上的熊猫 -->
        <div class="mascot-container">
            <svg viewBox="0 0 200 160" xmlns="http://www.w3.org/2000/svg">
                <!-- 身体阴影 -->
                <path d="M40 160 Q100 150 160 160" fill="none" stroke="rgba(0,0,0,0.1)" stroke-width="4"/>
                <!-- 耳朵 -->
                <circle cx="50" cy="50" r="22" fill="#1f2937"/>
                <circle cx="150" cy="50" r="22" fill="#1f2937"/>
                <!-- 脸 -->
                <ellipse cx="100" cy="90" rx="70" ry="60" fill="#fff"/>
                <!-- 眼睛 -->
                <ellipse cx="70" cy="85" rx="18" ry="22" fill="#1f2937" transform="rotate(-20 70 85)"/>
                <ellipse cx="130" cy="85" rx="18" ry="22" fill="#1f2937" transform="rotate(20 130 85)"/>
                <circle cx="72" cy="82" r="5" fill="#fff"/>
                <circle cx="128" cy="82" r="5" fill="#fff"/>
                <!-- 鼻子 -->
                <ellipse cx="100" cy="115" rx="10" ry="7" fill="#1f2937"/>
                <!-- 装饰：小竹叶 -->
                <path d="M140 120 Q160 100 180 110 Q160 120 140 120" fill="#10b981"/>
            </svg>
        </div>

        <div class="header">
            <div class="title-group">
                <!-- MyShell 风格 Logo -->
                <div class="logo-box">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </div>
                <div class="title-text">
                    <h1>User Management</h1>
                    <p>管理系统核心用户数据</p>
                </div>
            </div>
            
            <!-- 新增功能：添加用户按钮 -->
            <button class="btn-add" onclick="openAddModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                </svg>
                新增用户
            </button>
        </div>

        <div class="controls">
            <div class="search-box">
                <span class="search-icon">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </span>
                <input type="text" id="searchInput" placeholder="搜索姓名 / 邮箱 / 手机号">
            </div>
            <div class="filter-group">
                <select id="filterStatus" class="filter-select" aria-label="筛选用户状态">
                    <option value="">全部状态</option>
                    <option value="active">正常用户</option>
                    <option value="inactive">已停用</option>
                </select>
                <select id="filterRole" class="filter-select" aria-label="筛选用户角色">
                    <option value="">全部角色</option>
                    <option value="admin">管理员</option>
                    <option value="user">普通用户</option>
                </select>
                <select id="filterMembership" class="filter-select" aria-label="筛选会员类型">
                    <option value="">全部会员</option>
                    <option value="annual_card">年卡</option>
                    <option value="monthly_card">月卡</option>
                    <option value="session_card">次卡</option>
                    <option value="no_membership">无会员</option>
                </select>
                <button type="button" class="btn-refresh" id="btnResetFilters">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 1 0 6 4.33"/></svg>
                    清除筛选
                </button>
                <button type="button" class="btn-refresh subtle" id="btnRefresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 15A9 9 0 1 0 18 19.67"/></svg>
                    刷新数据
                </button>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll-container" id="tableScrollContainer">
                <table id="userTable" class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('username')">
                                用户名 <span id="icon-username" class="sort-icon">⇅</span>
                            </th>
                            <th>邮箱地址</th>
                            <th onclick="sortTable('phone')">
                                手机号 <span id="icon-phone" class="sort-icon">⇅</span>
                            </th>
                            <th onclick="sortTable('role')">
                                用户角色 <span id="icon-role" class="sort-icon">⇅</span>
                            </th>
                            <th onclick="sortTable('membership_type')">
                                会员类型 <span id="icon-membership_type" class="sort-icon">⇅</span>
                            </th>
                            <th onclick="sortTable('regTime')">
                                注册时间 <span id="icon-regTime" class="sort-icon">⇅</span>
                            </th>
                            <th onclick="sortTable('updatedAt')">
                                最近更新 <span id="icon-updatedAt" class="sort-icon">⇅</span>
                            </th>
                            <th>用户状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- 数据将由 JS 渲染 -->
                    </tbody>
                </table>
            </div>
            <div class="table-scroll-indicator" id="scrollIndicator">
                ← 横向滚动查看更多 →
            </div>
        </div>

        <!-- 分页组件 -->
        <div class="pagination-wrapper" id="paginationWrapper">
            <!-- 分页控件将由 JS 渲染 -->
        </div>
    </div>

    <!-- 1. 新增用户模态框 - 优化版 -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2>添加新用户</h2>
            </div>
            <div class="modal-content">
                <form id="addForm">
                    <!-- 基本信息区域 -->
                    <div class="form-section">
                        <h3 class="section-title">基本信息</h3>
                        <div class="form-group">
                            <label class="form-label">用户名 <span class="required-indicator">*</span></label>
                            <input type="text" id="addUsername" class="form-input" placeholder="例如: PandaUser" required minlength="2" maxlength="50">
                            <small class="form-help">2-50个字符，支持中文、英文、数字</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">邮箱 <span class="required-indicator">*</span></label>
                            <input type="email" id="addEmail" class="form-input" placeholder="user@example.com" required>
                            <small class="form-help">请输入有效的邮箱地址，用于登录和通知</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">手机号 <span class="required-indicator">*</span></label>
                            <input type="tel" id="addPhone" class="form-input" placeholder="13800138000" required pattern="1[3-9]\d{9}">
                            <small class="form-help">中国手机号格式，11位数字</small>
                        </div>
                    </div>

                    <!-- 安全信息区域 -->
                    <div class="form-section">
                        <h3 class="section-title">安全信息</h3>
                        <div class="form-group">
                            <label class="form-label">密码 <span class="required-indicator">*</span></label>
                            <input type="password" id="addPassword" class="form-input" placeholder="输入密码" required minlength="6">
                            <small class="form-help">最少6位字符，建议包含字母和数字</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">确认密码</label>
                            <input type="password" id="addPasswordConfirmation" class="form-input" placeholder="再次输入密码">
                            <small class="form-help">请再次输入密码以确认</small>
                        </div>
                    </div>

                    <!-- 权限设置区域 -->
                    <div class="form-section">
                        <h3 class="section-title">权限设置</h3>
                        <div class="form-group">
                            <label class="form-label">用户角色</label>
                            <select id="addRole" class="form-input">
                                <option value="user">普通用户 - 基础功能权限</option>
                                <option value="admin">管理员 - 全部功能权限</option>
                            </select>
                            <small class="form-help">角色决定用户的系统权限范围</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">会员类型</label>
                            <select id="addMembership" class="form-input">
                                <option value="no_membership">无会员</option>
                                <option value="session_card">次卡 - 按次数计费</option>
                                <option value="monthly_card">月卡 - 月度会员</option>
                                <option value="annual_card">年卡 - 年度会员</option>
                            </select>
                            <small class="form-help">会员类型影响服务使用权限</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">初始状态</label>
                            <select id="addStatus" class="form-input">
                                <option value="Active">正常 - 账户可以正常使用</option>
                                <option value="Inactive">停用 - 账户暂时不可用</option>
                            </select>
                            <small class="form-help">新创建用户的初始状态设置</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addModal')">取消</button>
                <button type="button" class="btn-submit" onclick="submitAddForm()">确认添加</button>
            </div>
        </div>
    </div>

    <!-- 2. 编辑用户模态框 -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2>✏️ 编辑用户</h2>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" id="editUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">邮箱</label>
                    <input type="email" id="editEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">手机号</label>
                    <input type="tel" id="editPhone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">用户角色</label>
                    <select id="editRole" class="form-input">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">会员类型</label>
                    <select id="editMembership" class="form-input">
                        <option value="no_membership">无会员</option>
                        <option value="session_card">次卡</option>
                        <option value="monthly_card">月卡</option>
                        <option value="annual_card">年卡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">用户状态</label>
                    <select id="editStatus" class="form-input">
                        <option value="Active">正常 (Active)</option>
                        <option value="Inactive">停用 (Inactive)</option>
                        <option value="Banned">封禁 (Banned)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('editModal')">取消</button>
                    <button type="submit" class="btn-submit">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/v1/users/search';
        const MEMBERSHIP_TEXT = {
            session_card: '次卡',
            monthly_card: '月卡',
            annual_card: '年卡',
            no_membership: '无会员'
        };

        const STATUS_MAPPING = {
            'Active': 'active',
            'Inactive': 'inactive',
            'Banned': 'inactive' // 封禁也映射为inactive
        };

        const state = {
            users: [],
            currentData: [],
            isLoading: false,
            currentPage: 1,
            perPage: 20,
            totalPages: 1,
            totalCount: 0,
            keyword: '',
            filters: {
                status: '',
                role: '',
                membership_type: ''
            },
            sortStates: {
                username: 'none',
                regTime: 'none',
                updatedAt: 'none',
                phone: 'none',
                role: 'none',
                membership_type: 'none'
            },
            scrollInitialized: false
        };

        const SORT_ICONS = { asc: '↑', desc: '↓', none: '⇅' };

        /* 通知系统 */
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 触发动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        /* 显示加载状态 */
        function showLoading(button, text = '处理中...') {
            if (!button) return;
            button.dataset.originalText = button.textContent;
            button.dataset.originalDisabled = button.disabled;
            button.textContent = text;
            button.disabled = true;
        }

        /* 隐藏加载状态 */
        function hideLoading(button) {
            if (!button) return;
            button.textContent = button.dataset.originalText || button.textContent;
            button.disabled = button.dataset.originalDisabled === 'true';
            delete button.dataset.originalText;
            delete button.dataset.originalDisabled;
        }

        /* 显示表单验证错误 */
        function showFormError(inputId, message) {
            const input = document.getElementById(inputId);
            const formGroup = input.closest('.form-group');
            if (!formGroup) return;

            // 清除之前的错误
            const existingError = formGroup.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // 创建错误消息元素
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;

            // 添加错误样式和消息
            formGroup.classList.add('has-error');
            formGroup.classList.remove('success');
            formGroup.appendChild(errorElement);

            // 添加输入事件监听器来自动清除错误
            const clearError = function() {
                formGroup.classList.remove('has-error');
                errorElement.remove();
                input.removeEventListener('input', clearError);
                // 重新验证
                validateField(inputId);
            };
            input.addEventListener('input', clearError);
        }

        /* 显示表单验证成功 */
        function showFormSuccess(inputId) {
            const input = document.getElementById(inputId);
            const formGroup = input.closest('.form-group');
            if (!formGroup) return;

            // 清除错误状态
            formGroup.classList.remove('has-error');
            const existingError = formGroup.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // 添加成功样式
            formGroup.classList.add('success');
        }

        /* 验证单个字段 */
        function validateField(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return true; // 如果元素不存在，返回true
            
            const value = input.value.trim();
            let isValid = true;

            switch(inputId) {
                case 'addUsername':
                    if (!value || value.length < 2 || value.length > 50) {
                        showFormError(inputId, '用户名长度必须在2-50个字符之间');
                        isValid = false;
                    }
                    break;
                case 'addEmail':
                    if (!value || !value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                        showFormError(inputId, '请输入有效的邮箱地址');
                        isValid = false;
                    }
                    break;
                case 'addPhone':
                    if (!value || !value.match(/^1[3-9]\d{9}$/)) {
                        showFormError(inputId, '请输入有效的中国手机号');
                        isValid = false;
                    }
                    break;
                case 'addPassword':
                    if (!value || value.length < 6) {
                        showFormError(inputId, '密码长度不能少于6位');
                        isValid = false;
                    }
                    break;
                case 'addPasswordConfirmation':
                    const password = document.getElementById('addPassword').value;
                    if (value && value !== password) {
                        showFormError(inputId, '密码确认不匹配');
                        isValid = false;
                    }
                    break;
            }

            if (isValid) {
                showFormSuccess(inputId);
            }
            return isValid;
        }

        /* 实时表单验证 */
        function setupRealTimeValidation() {
            const formFields = ['addUsername', 'addEmail', 'addPhone', 'addPassword', 'addPasswordConfirmation'];
            formFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    // 失去焦点时验证
                    input.addEventListener('blur', () => validateField(fieldId));
                    // 输入时清除错误状态
                    input.addEventListener('input', () => {
                        const formGroup = input.closest('.form-group');
                        if (formGroup && formGroup.classList.contains('has-error')) {
                            formGroup.classList.remove('has-error');
                            const errorElement = formGroup.querySelector('.error-message');
                            if (errorElement) {
                                errorElement.remove();
                            }
                        }
                    });
                }
            });
        }

        /* 增强的密码强度指示器 */
        function setupPasswordStrength() {
            const passwordInput = document.getElementById('addPassword');
            if (!passwordInput) return;

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const formGroup = this.closest('.form-group');
                
                // 移除之前的强度指示器
                const existingStrength = formGroup.querySelector('.password-strength');
                if (existingStrength) {
                    existingStrength.remove();
                }

                if (password.length === 0) return;

                // 计算密码强度
                let strength = 0;
                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/\d/.test(password)) strength++;
                if (/[^a-zA-Z\d]/.test(password)) strength++;

                // 创建强度指示器
                const strengthDiv = document.createElement('div');
                strengthDiv.className = 'password-strength';
                
                const strengthLabels = ['很弱', '弱', '一般', '强', '很强'];
                const strengthColors = ['#ef4444', '#f59e0b', '#eab308', '#10b981', '#059669'];
                
                strengthDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
                        <div style="flex: 1; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: ${(strength / 5) * 100}%; background: ${strengthColors[strength - 1]}; transition: width 0.3s;"></div>
                        </div>
                        <span style="font-size: 0.8rem; color: ${strengthColors[strength - 1]}; font-weight: 500;">${strengthLabels[strength - 1]}</span>
                    </div>
                `;
                
                formGroup.appendChild(strengthDiv);
            });
        }

        /* 清除所有表单错误 */
        function clearFormErrors() {
            document.querySelectorAll('.form-group.has-error').forEach(group => {
                group.classList.remove('has-error');
                const errorMessage = group.querySelector('.error-message');
                if (errorMessage) {
                    errorMessage.remove();
                }
            });
        }

        function debounce(fn, delay = 300) {
            let timerId;
            return (...args) => {
                if (timerId) {
                    clearTimeout(timerId);
                }
                timerId = setTimeout(() => fn(...args), delay);
            };
        }

        const debouncedSearch = debounce((keyword) => {
            loadUsersData({ keyword, page: 1 });
        }, 350);

        document.addEventListener('DOMContentLoaded', () => {
            bindInteractions();
            bindFormHandlers();
            loadUsersData();
            initializeTableScroll();

            // 初始化表单增强功能
            initializeFormEnhancements();

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    loadUsersData({ page: state.currentPage });
                }
            });

            window.addEventListener('focus', () => {
                loadUsersData({ page: state.currentPage });
            });

            window.addEventListener('resize', () => {
                setTimeout(checkTableOverflow, 120);
            });
        });

        /* 表单增强功能初始化 */
        function initializeFormEnhancements() {
            console.log('Initializing form enhancements...');
            
            // 为新增用户按钮添加键盘快捷键
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + N 打开新增用户模态框
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openAddModal();
                }
                // Esc 关闭模态框
                if (e.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal-overlay.show');
                    openModals.forEach(modal => {
                        const modalId = modal.id;
                        if (modalId) closeModal(modalId);
                    });
                }
            });

            // 测试按钮点击事件
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-submit')) {
                    console.log('Submit button clicked:', e.target);
                    console.log('Button text:', e.target.textContent);
                    console.log('Button type:', e.target.type);
                    console.log('Button onclick:', e.target.onclick);
                }
            });

            // 为模态框内的表单添加回车键提交支持
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.closest('.modal-content')) {
                    const submitButton = e.target.closest('.modal-card').querySelector('.btn-submit');
                    if (submitButton && !submitButton.disabled) {
                        e.preventDefault();
                        const form = e.target.closest('form');
                        if (form && form.checkValidity()) {
                            form.dispatchEvent(new Event('submit'));
                        }
                    }
                }
            });

            // 自动聚焦第一个输入框当模态框打开时
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.classList.contains('show') && target.classList.contains('modal-overlay')) {
                            setTimeout(() => {
                                const firstInput = target.querySelector('.form-input');
                                if (firstInput) {
                                    firstInput.focus();
                                }
                            }, 100);
                        }
                    }
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                observer.observe(modal, { attributes: true });
            });
        }

        function bindInteractions() {
            const searchInput = document.getElementById('searchInput');
            const filterStatus = document.getElementById('filterStatus');
            const filterRole = document.getElementById('filterRole');
            const filterMembership = document.getElementById('filterMembership');
            const resetBtn = document.getElementById('btnResetFilters');
            const refreshBtn = document.getElementById('btnRefresh');

            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }

            if (filterStatus) {
                filterStatus.addEventListener('change', (event) => handleFilterChange('status', event.target.value));
            }

            if (filterRole) {
                filterRole.addEventListener('change', (event) => handleFilterChange('role', event.target.value));
            }

            if (filterMembership) {
                filterMembership.addEventListener('change', (event) => handleFilterChange('membership_type', event.target.value));
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', resetFilters);
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => loadUsersData({ page: state.currentPage }));
            }
        }

        function bindFormHandlers() {
            console.log('Binding form handlers...');
            const addForm = document.getElementById('addForm');
            const editForm = document.getElementById('editForm');

            if (addForm) {
                console.log('Add form found, binding submit event');
                addForm.addEventListener('submit', handleAddSubmit);
            } else {
                console.error('Add form not found');
            }

            if (editForm) {
                console.log('Edit form found, binding submit event');
                editForm.addEventListener('submit', handleEditSubmit);
            }
        }

        function handleSearch(event) {
            const keyword = event.target.value.trim();
            debouncedSearch(keyword);
        }

        function handleFilterChange(key, value) {
            state.filters[key] = value;
            loadUsersData({ page: 1 });
        }

        function resetFilters() {
            state.filters = { status: '', role: '', membership_type: '' };
            state.keyword = '';
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';

            const filterStatus = document.getElementById('filterStatus');
            const filterRole = document.getElementById('filterRole');
            const filterMembership = document.getElementById('filterMembership');
            if (filterStatus) filterStatus.value = '';
            if (filterRole) filterRole.value = '';
            if (filterMembership) filterMembership.value = '';

            loadUsersData({ page: 1 });
        }

        function buildFiltersPayload() {
            const payload = {};
            if (state.keyword) {
                payload.name = state.keyword;
            }
            Object.entries(state.filters).forEach(([key, value]) => {
                if (value) {
                    payload[key] = value;
                }
            });
            return payload;
        }

        function mapUserFromApi(user) {
            const createdAt = user.created_at || '';
            const updatedAt = user.updated_at || createdAt;
            return {
                id: user.id,
                username: user.nickname || '未命名用户',
                email: user.email || '-',
                phone: user.phone || '',
                role: user.role || 'user',
                membership_type: user.membership_type || 'no_membership',
                status: (user.status || 'inactive').toLowerCase(),
                createdAtRaw: createdAt ? Date.parse(createdAt) : null,
                updatedAtRaw: updatedAt ? Date.parse(updatedAt) : null,
                createdAtDisplay: formatDateShort(createdAt),
                updatedAtDisplay: formatDateShort(updatedAt),
                createdAtFull: formatDateLong(createdAt),
                updatedAtFull: formatDateLong(updatedAt),
                createdAtSource: createdAt,
                updatedAtSource: updatedAt
            };
        }

        function formatDateShort(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function formatDateLong(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('zh-CN', { hour12: false });
        }

        async function loadUsersData(options = {}) {
            if (state.isLoading) return;

            const keyword = options.keyword !== undefined ? options.keyword : state.keyword;
            const page = options.page || 1;
            const pageSize = options.pageSize || state.perPage;

            state.isLoading = true;
            state.keyword = keyword;
            state.currentPage = page;
            state.perPage = pageSize;
            showLoadingState();

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        filters: buildFiltersPayload(),
                        pagination: {
                            page: state.currentPage,
                            per_page: state.perPage
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '获取用户数据失败');
                }

                const pagination = result.data.pagination || {};
                state.totalPages = Math.max(pagination.total_pages || 1, 1);
                state.totalCount = pagination.total_count || 0;

                if (state.totalCount > 0 && state.currentPage > state.totalPages) {
                    state.currentPage = state.totalPages;
                    state.isLoading = false;
                    return loadUsersData({ page: state.currentPage });
                }

                state.users = (result.data.users || []).map(mapUserFromApi);
                state.currentData = [...state.users];
                resetSortIcons();
                renderTable(state.currentData);
                renderPagination();

                setTimeout(() => {
                    adjustColumnWidths();
                    checkTableOverflow();
                }, 60);
            } catch (error) {
                console.error('加载用户数据失败:', error);
                showErrorState(error.message);
            } finally {
                state.isLoading = false;
            }
        }

        function showLoadingState() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #999; white-space: normal;">🔄 正在加载用户数据...<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">请稍候，正在从服务器获取最新数据</small></td></tr>';
        }

        function showErrorState(errorMessage) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 40px; color: #e53e3e; white-space: normal;">❌ 加载失败: ${errorMessage}<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">请检查网络连接或稍后重试</small><br><button onclick="loadUsersData()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">重新加载</button></td></tr>`;
        }

        function renderPagination() {
            const wrapper = document.getElementById('paginationWrapper');
            if (!wrapper) return;

            const hasData = state.totalCount > 0;
            const startItem = hasData ? (state.currentPage - 1) * state.perPage + 1 : 0;
            const endItem = hasData ? Math.min(state.currentPage * state.perPage, state.totalCount) : 0;

            let html = `
                <div class="pagination-info">
                    <span>显示 ${hasData ? startItem : 0}-${hasData ? endItem : 0} 条，共 ${state.totalCount} 条记录</span>
                    <span>第 ${state.currentPage} / ${state.totalPages} 页</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>上一页</button>
            `;

            const maxVisiblePages = 5;
            let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(state.totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                html += `<button class="pagination-btn ${state.currentPage === 1 ? 'active' : ''}" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis" style="padding: 0 4px;">...</span>`;
                }
            }

            for (let page = startPage; page <= endPage; page++) {
                html += `<button class="pagination-btn ${page === state.currentPage ? 'active' : ''}" onclick="changePage(${page})">${page}</button>`;
            }

            if (endPage < state.totalPages) {
                if (endPage < state.totalPages - 1) {
                    html += `<span class="pagination-ellipsis" style="padding: 0 4px;">...</span>`;
                }
                html += `<button class="pagination-btn ${state.currentPage === state.totalPages ? 'active' : ''}" onclick="changePage(${state.totalPages})">${state.totalPages}</button>`;
            }

            html += `
                    <button class="pagination-btn" onclick="changePage(${state.currentPage + 1})" ${state.currentPage === state.totalPages ? 'disabled' : ''}>下一页</button>
                    <select class="page-size-selector" onchange="changePageSize(this.value)">
                        <option value="10" ${state.perPage === 10 ? 'selected' : ''}>10条/页</option>
                        <option value="20" ${state.perPage === 20 ? 'selected' : ''}>20条/页</option>
                        <option value="50" ${state.perPage === 50 ? 'selected' : ''}>50条/页</option>
                        <option value="100" ${state.perPage === 100 ? 'selected' : ''}>100条/页</option>
                    </select>
                </div>
            `;

            wrapper.innerHTML = html;
        }

        function changePage(page) {
            if (page < 1 || page > state.totalPages || page === state.currentPage) return;
            loadUsersData({ page });
        }

        function changePageSize(value) {
            const size = Math.min(Math.max(parseInt(value, 10) || 20, 1), 100);
            loadUsersData({ page: 1, pageSize: size });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #999; white-space: normal;">🔍 未找到匹配的用户<br><small style="font-size: 0.8rem; margin-top: 8px; display: block;">请尝试调整搜索条件或清除搜索关键词</small></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach((user) => {
                const safeName = user.username || '未命名用户';
                const avatarText = safeName.trim().charAt(0).toUpperCase() || 'U';
                const statusMeta = getStatusMeta(user.status);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-cell">
                            <div class="avatar">${avatarText}</div>
                            <span style="font-weight:600;" title="${safeName}">${optimizeTextDisplay(safeName, 15)}</span>
                        </div>
                    </td>
                    <td style="color:var(--text-sub);" title="${user.email}">${optimizeTextDisplay(user.email, 25)}</td>
                    <td style="color:var(--text-sub);" title="${user.phone}">${user.phone ? optimizeTextDisplay(user.phone, 15) : '-'}</td>
                    <td>
                        <span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}" title="${user.role === 'admin' ? '管理员' : '普通用户'}">
                            ${user.role === 'admin' ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td>
                        <span class="membership-badge membership-${user.membership_type}" title="${getMembershipText(user.membership_type)}">
                            ${getMembershipText(user.membership_type)}
                        </span>
                    </td>
                    <td style="font-family:monospace; color:var(--text-sub);" title="${user.createdAtFull}">${user.createdAtDisplay}</td>
                    <td style="font-family:monospace; color:var(--text-sub);" title="${user.updatedAtFull}">${user.updatedAtDisplay}</td>
                    <td>
                        <span class="badge ${statusMeta.cssClass}" title="${statusMeta.text}">
                            <span class="dot"></span>${statusMeta.text}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="openEdit(${user.id})" title="编辑用户">编辑</button>
                            <button class="btn-action btn-del" onclick="deleteUser(${user.id})" title="删除用户">删除</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function optimizeTextDisplay(text, maxLength = 50) {
            if (!text) return '-';
            return text.length <= maxLength ? text : `${text.substring(0, maxLength)}...`;
        }

        function getStatusMeta(status) {
            const normalized = (status || 'inactive').toLowerCase();
            if (normalized === 'active') return { cssClass: 'status-active', text: '正常' };
            if (normalized === 'inactive') return { cssClass: 'status-inactive', text: '停用' };
            return { cssClass: 'status-banned', text: '封禁' };
        }

        function getMembershipText(value) {
            return MEMBERSHIP_TEXT[value] || '未知';
        }

        function sortTable(key) {
            const currentState = state.sortStates[key] || 'none';
            const nextState = currentState === 'asc' ? 'desc' : 'asc';
            state.sortStates[key] = nextState;
            updateSortIcons(key);

            state.currentData.sort((a, b) => {
                let aValue;
                let bValue;

                switch (key) {
                    case 'username':
                        aValue = (a.username || '').toLowerCase();
                        bValue = (b.username || '').toLowerCase();
                        break;
                    case 'phone':
                        aValue = a.phone || '';
                        bValue = b.phone || '';
                        break;
                    case 'role':
                        const roleOrder = { admin: 0, user: 1 };
                        aValue = roleOrder[a.role] ?? 2;
                        bValue = roleOrder[b.role] ?? 2;
                        break;
                    case 'membership_type':
                        const membershipOrder = { annual_card: 0, monthly_card: 1, session_card: 2, no_membership: 3 };
                        aValue = membershipOrder[a.membership_type] ?? 4;
                        bValue = membershipOrder[b.membership_type] ?? 4;
                        break;
                    case 'regTime':
                        aValue = a.createdAtRaw || 0;
                        bValue = b.createdAtRaw || 0;
                        break;
                    case 'updatedAt':
                        aValue = a.updatedAtRaw || 0;
                        bValue = b.updatedAtRaw || 0;
                        break;
                    default:
                        aValue = a[key];
                        bValue = b[key];
                }

                if (aValue < bValue) return nextState === 'asc' ? -1 : 1;
                if (aValue > bValue) return nextState === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(state.currentData);
        }

        function updateSortIcons(activeKey) {
            Object.keys(state.sortStates).forEach((key) => {
                const icon = document.getElementById(`icon-${key}`);
                if (!icon) return;

                if (key === activeKey) {
                    icon.textContent = SORT_ICONS[state.sortStates[key]];
                    icon.classList.toggle('active', state.sortStates[key] !== 'none');
                } else {
                    state.sortStates[key] = 'none';
                    icon.textContent = SORT_ICONS.none;
                    icon.classList.remove('active');
                }
            });
        }

        function resetSortIcons() {
            Object.keys(state.sortStates).forEach((key) => {
                state.sortStates[key] = 'none';
                const icon = document.getElementById(`icon-${key}`);
                if (icon) {
                    icon.textContent = SORT_ICONS.none;
                    icon.classList.remove('active');
                }
            });
        }

        function initializeTableScroll() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            if (!scrollContainer) return;

            if (!state.scrollInitialized) {
                const scrollIndicator = document.getElementById('scrollIndicator');
                scrollContainer.addEventListener('scroll', () => {
                    if (!scrollIndicator) return;
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                    if (maxScroll <= 10) {
                        scrollIndicator.classList.remove('show');
                        return;
                    }

                    scrollIndicator.classList.add('show');
                    if (scrollContainer.scrollLeft < 50) {
                        scrollIndicator.textContent = '→ 横向滚动查看更多';
                    } else if (scrollContainer.scrollLeft > maxScroll - 50) {
                        scrollIndicator.textContent = '← 已滚动到最右侧';
                    } else {
                        scrollIndicator.textContent = '← → 继续滚动查看更多';
                    }
                });
                state.scrollInitialized = true;
            }

            setTimeout(checkTableOverflow, 80);
        }

        function checkTableOverflow() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            const scrollIndicator = document.getElementById('scrollIndicator');
            if (!scrollContainer || !scrollIndicator) return;

            const hasOverflow = scrollContainer.scrollWidth > scrollContainer.clientWidth;
            scrollIndicator.classList.toggle('show', hasOverflow);
        }

        function adjustColumnWidths() {
            const table = document.getElementById('userTable');
            if (!table) return;

            const headerCells = Array.from(table.querySelectorAll('thead th'));
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (!rows.length) return;

            const maxWidths = new Array(headerCells.length).fill(0);
            headerCells.forEach((cell, index) => {
                maxWidths[index] = Math.max(maxWidths[index], cell.textContent.trim().length * 8 + 20);
            });

            rows.forEach((row) => {
                Array.from(row.children).forEach((cell, index) => {
                    const contentLength = cell.textContent.trim().length * 8 + 40;
                    maxWidths[index] = Math.max(maxWidths[index], contentLength);
                });
            });

            headerCells.forEach((cell, index) => {
                const style = getComputedStyle(cell);
                const minWidth = parseInt(style.minWidth, 10) || 80;
                const maxWidth = parseInt(style.maxWidth, 10) || 300;
                const optimal = Math.min(Math.max(maxWidths[index], minWidth), maxWidth);
                cell.style.width = `${optimal}px`;
                cell.style.minWidth = `${optimal}px`;
            });
        }

        function refreshLocalPagination() {
            state.totalCount = state.currentData.length;
            state.totalPages = Math.max(1, Math.ceil(state.totalCount / state.perPage));
            state.currentPage = Math.min(state.currentPage, state.totalPages);
        }

        async function deleteUser(id) {
            if (!confirm('确定要删除此用户吗？操作不可恢复。')) return;

            // 找到对应的删除按钮并显示加载状态
            const deleteButton = document.querySelector(`button[onclick="deleteUser(${id})"]`);
            showLoading(deleteButton, '删除中...');

            try {
                const response = await fetch('/api/v1/users/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: id
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '删除用户失败');
                }

                // 从本地状态中移除用户
                state.users = state.users.filter((user) => user.id !== id);
                state.currentData = state.currentData.filter((user) => user.id !== id);
                refreshLocalPagination();
                renderTable(state.currentData);
                renderPagination();
                
                showNotification('✅ 用户删除成功！', 'success');
            } catch (error) {
                console.error('删除用户失败:', error);
                showNotification(`❌ 删除用户失败: ${error.message}`, 'error');
            } finally {
                hideLoading(deleteButton);
            }
        }

        function openAddModal() {
            const form = document.getElementById('addForm');
            if (form) {
                form.reset();
                // 清除所有验证状态
                form.querySelectorAll('.form-group').forEach(group => {
                    group.classList.remove('has-error', 'success');
                    const errorElement = group.querySelector('.error-message');
                    if (errorElement) {
                        errorElement.remove();
                    }
                    const strengthElement = group.querySelector('.password-strength');
                    if (strengthElement) {
                        strengthElement.remove();
                    }
                });
            }
            
            // 设置实时验证
            setupRealTimeValidation();
            
            // 设置密码强度指示器
            setupPasswordStrength();
            
            // 显示模态框
            document.getElementById('addModal').classList.add('show');
        }

        /* 处理新增用户表单提交 */
        function submitAddForm() {
            console.log('Submit add form clicked');
            const form = document.getElementById('addForm');
            if (!form) {
                console.error('Add form not found');
                showNotification('❌ 表单未找到', 'error');
                return;
            }

            // 检查表单验证
            if (!form.checkValidity()) {
                console.log('Form validation failed');
                form.reportValidity(); // 显示浏览器的默认验证提示
                return;
            }

            try {
                // 手动触发表单的submit事件
                const event = new Event('submit', { bubbles: true, cancelable: true });
                const result = form.dispatchEvent(event);
                
                console.log('Form submit event dispatched, result:', result);
                
                // 如果表单验证失败，result会是false
                if (!result) {
                    console.log('Form submission was prevented');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showNotification('❌ 表单提交失败: ' + error.message, 'error');
            }
        }

        function openEdit(id) {
            const user = state.users.find((item) => item.id === id);
            if (!user) return;

            document.getElementById('editId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editRole').value = user.role || 'user';
            document.getElementById('editMembership').value = user.membership_type || 'no_membership';
            
            // 状态映射：从后端值到前端显示值
            let statusValue = 'Inactive'; // 默认值
            if (user.status === 'active') {
                statusValue = 'Active';
            } else if (user.status === 'inactive') {
                statusValue = 'Inactive';
            }
            document.getElementById('editStatus').value = statusValue;

            document.getElementById('editModal').classList.add('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        async function handleAddSubmit(event) {
            console.log('handleAddSubmit called, preventing default...');
            console.log('Event target:', event.target);
            console.log('Event type:', event.type);
            
            event.preventDefault();
            
            // 获取提交按钮 - 注意：event.target是form元素，不是按钮
            const form = event.target;
            const submitButton = form.querySelector('.btn-submit') || document.querySelector('.modal-footer .btn-submit');
            console.log('Submit button found:', submitButton);
            
            // 添加加载状态样式
            if (submitButton) {
                submitButton.classList.add('loading');
                showLoading(submitButton, '创建中...');
            } else {
                console.error('Submit button not found!');
            }

            try {
                // 清除之前的表单错误
                clearFormErrors();

                // 执行完整的表单验证
                const formFields = ['addUsername', 'addEmail', 'addPhone', 'addPassword', 'addPasswordConfirmation'];
                let hasErrors = false;

                formFields.forEach(fieldId => {
                    if (!validateField(fieldId)) {
                        hasErrors = true;
                    }
                });

                if (hasErrors) {
                    showNotification('❌ 请检查并修正表单中的错误', 'error', 5000);
                    return;
                }

                // 获取表单数据
                const nickname = document.getElementById('addUsername').value.trim();
                const email = document.getElementById('addEmail').value.trim();
                const phone = document.getElementById('addPhone').value.trim();
                const password = document.getElementById('addPassword').value;
                const passwordConfirmation = document.getElementById('addPasswordConfirmation').value;
                const role = document.getElementById('addRole').value;
                const membershipType = document.getElementById('addMembership').value;
                const statusValue = document.getElementById('addStatus').value;

                // 准备创建数据
                const createData = {
                    user: {
                        nickname: nickname,
                        email: email,
                        phone: phone,
                        password: password,
                        password_confirmation: passwordConfirmation || password,
                        role: role,
                        membership_type: membershipType,
                        status: STATUS_MAPPING[statusValue] || statusValue.toLowerCase()
                    }
                };

                // 调用后端API创建用户
                const response = await fetch('/api/v1/users/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(createData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '创建用户失败');
                }

                // 创建成功后，将新用户添加到本地状态
                const newUser = mapUserFromApi({
                    id: result.data.id,
                    nickname: result.data.nickname,
                    email: result.data.email,
                    phone: result.data.phone,
                    role: result.data.role,
                    membership_type: result.data.membership_type,
                    status: result.data.status,
                    created_at: result.data.created_at,
                    updated_at: result.data.updated_at
                });

                // 更新本地状态并刷新显示
                state.currentPage = 1;
                state.users.unshift(newUser);
                state.currentData.unshift(newUser);
                refreshLocalPagination();
                renderTable(state.currentData);
                renderPagination();

                // 显示成功通知
                showNotification('🎉 新用户创建成功！', 'success', 4000);

                // 关闭模态框并重置表单
                closeModal('addModal');
                const form = document.getElementById('addForm');
                if (form) {
                    form.reset();
                    // 清除所有验证状态
                    form.querySelectorAll('.form-group').forEach(group => {
                        group.classList.remove('has-error', 'success');
                        const errorElement = group.querySelector('.error-message');
                        if (errorElement) {
                            errorElement.remove();
                        }
                        const strengthElement = group.querySelector('.password-strength');
                        if (strengthElement) {
                            strengthElement.remove();
                        }
                    });
                }

            } catch (error) {
                console.error('创建用户失败:', error);
                showNotification(`❌ 创建用户失败: ${error.message}`, 'error', 5000);
            } finally {
                // 移除加载状态
                submitButton.classList.remove('loading');
                hideLoading(submitButton);
            }
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('.btn-submit');
            showLoading(submitButton, '保存中...');

            try {
                const id = parseInt(document.getElementById('editId').value, 10);
                const index = state.users.findIndex((user) => user.id === id);
                if (index === -1) {
                    throw new Error('未找到该用户');
                }

                // 准备更新数据
                const statusValue = document.getElementById('editStatus').value;
                const updateData = {
                    user_id: id,
                    user: {
                        nickname: document.getElementById('editUsername').value,
                        email: document.getElementById('editEmail').value,
                        phone: document.getElementById('editPhone').value,
                        role: document.getElementById('editRole').value,
                        membership_type: document.getElementById('editMembership').value,
                        status: STATUS_MAPPING[statusValue] || statusValue.toLowerCase()
                    }
                };

                // 调用后端API更新用户
                const response = await fetch('/api/v1/users/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '更新用户失败');
                }

                // 更新本地状态
                const existing = state.users[index];
                const updatedUser = mapUserFromApi({
                    id: existing.id,
                    nickname: document.getElementById('editUsername').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    membership_type: document.getElementById('editMembership').value,
                    status: STATUS_MAPPING[statusValue] || statusValue.toLowerCase(),
                    created_at: existing.createdAtSource,
                    updated_at: result.data.updated_at || new Date().toISOString()
                });

                state.users[index] = updatedUser;
                state.currentData = state.currentData.map((user) => (user.id === id ? updatedUser : user));
                renderTable(state.currentData);

                closeModal('editModal');
                showNotification('✅ 用户信息更新成功！', 'success');
            } catch (error) {
                console.error('更新用户失败:', error);
                showNotification(`❌ 更新用户失败: ${error.message}`, 'error');
            } finally {
                hideLoading(submitButton);
            }
        }

        window.addEventListener('click', (event) => {
            if (event.target.classList && event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>